<?php

module_load_include('inc', 'hitsa_content_page', 'includes/hitsa_content_page.theme');

/**
 * Implements hook_node_info()
 */
function hitsa_content_page_node_info() {
  return array(
    'content_page' => array(
      'name' => t('Content page'),
      'base' => 'content_page',
      'description' => t('A multipurpose content page.'),
      'has_title' => TRUE,
      'title_label' => t('Title'),
    ),
  );
}

// Field groups
/*
function hitsa_content_page_ctools_plugin_api($module, $api) {
  if ($module == 'field_group' && $api == 'field_group') {
    return array('version' => 1);
  }
}

function hitsa_content_page_field_group_info() {
  $groups = array();
  
  $groups['group_ci|paragraphs_item|subpage|form'] = (object) array(
    'identifier' => 'group_ci|paragraphs_item|subpage|form',
    'group_name' => 'group_ci',
    'entity_type' => 'paragraphs_item',
    'bundle' => 'subpage',
    'mode' => 'form',
    'parent_name' => '',
    'disabled' => false,
    'data' => array(
      'label' => 'Contact information',
      'weight' => '3',
      'children' => array(
        0 => 'cinfo_contact_person',
        1 => 'cinfo_homepage_url',
        2 => 'cinfo_e_mail',
        3 => 'cinfo_phone_nr',
        4 => 'cinfo_address',
      ),
      'format_type' => 'fieldset',
      'format_settings' => 
      array(
        'label' => 'Contact information',
        'instance_settings' => 
        array(
          'required_fields' => 1,
          'id' => '',
          'classes' => 'group-ci field-group-fieldset',
          'description' => '',
        ),
        'formatter' => 'collapsed',
      ),
    ),
  );
  dpm($groups);
  
  return $groups;
}
*/
/**
 * Implement hook_form()
 */
function content_page_form($node, $form_state) {
  return node_content_form($node, $form_state);
}

/**
 * Implement hook_form_alter()
 */
function hitsa_content_page_form_alter(&$form, &$form_state, $form_id) {
  global $user;
  if($form_id === 'content_page_node_form') {
    //$form['additional_settings']['#access'] = FALSE;
    // Show text summary by default.
    hitsa_core_formatted_text_show_summary();
    
    if($user->uid !== '1') {
      $form['cp_display_style']['#access'] = FALSE;
      //$form['cp_type']['#access'] = FALSE;
    }
    
    if(isset($form['cp_type'])) { // Set field conditions
      //dpm($form);
      if(!empty($form['cp_subpages'])) {
        $form['cp_subpages']['#states'] = array(
          'visible' => array(
            ':input[name^="cp_type"]' => array(
              array('value' => 'cp_tabbed'),
              array('value' => 'cp_service'),
            ),
          ),
        );
        if(!empty($form['cp_subpages'][LANGUAGE_NONE][0])) {
          $form['cp_subpages'][LANGUAGE_NONE][0]['subpage_title']['#states'] = array(
            'visible' => array(
              ':input[name^="cp_type"]' => array(
                array('value' => 'cp_tabbed'),
              ),
            ),
          );
        }
      }
      if(!empty($form['cp_contacts'])) {
        $form['cp_contacts']['#states'] = array(
          'visible' => array(
            ':input[name^="cp_type"]' => array(
              'value' => 'cp_contacts',
            ),
          ),
        );
      }
      if(!empty($form['cp_image'])) {
        $form['cp_image']['#states'] = array(
          'visible' => array(
            ':input[name^="cp_type"]' => array(
              array('value' => 'cp_tabbed'),
              array('value' => 'cp_service'),
              array('value' => 'cp_specialities'),
            ),
          ),
        );
      }
      if(!empty($form['body'])) {
        $form['body']['#states'] = array(
          'invisible' => array(
            ':input[name^="cp_type"]' => array(
              'value' => 'cp_contacts',
            ),
          ),
        );
      }
      if(!empty($form['field_school_selections'])) {
        $form['field_school_selections']['#states'] = array(
          'visible' => array(
            ':input[name^="cp_type"]' => array(
              'value' => 'cp_specialities',
            ),
          ),
          'required' => array(
            ':input[name^="cp_type"]' => array(
              'value' => 'cp_specialities',
            ),
          ),
        );
      }
      if(!empty($form['cp_display_style'])) {
        $form['cp_display_style']['#states'] = array(
          'invisible' => array(
            ':input[name^="cp_type"]' => array(
              'value' => 'cp_specialities',
            ),
          ),
        );
      }
      if(!empty($form['cp_service_type'])) {
        $form['cp_service_type']['#states'] = array(
          'visible' => array(
            ':input[name^="cp_type"]' => array(
              'value' => 'cp_service',
            ),
          ),
        );
      }
    }
    // Add subpage titles outside
    foreach($form['cp_subpages'][LANGUAGE_NONE] as &$subpage_fieldset) {
      if(!empty($subpage_fieldset['#entity']->subpage_title[LANGUAGE_NONE][0]['safe_value'])) {
        $subpage_title = $subpage_fieldset['#entity']->subpage_title[LANGUAGE_NONE][0]['safe_value'];
        $subpage_fieldset['#prefix'] = '<b>' . check_plain($subpage_title) . '</b>';
      }
    }
  }
}

/*
* Add menu link to service nodes.
*/
function hitsa_content_page_node_insert($node) {
  if($node->type === 'content_page') {
    $emw_node = entity_metadata_wrapper('node', $node);
    $cp_type = $emw_node->cp_type->value();
    if($cp_type === 'cp_service' && $service_type = $emw_node->cp_service_type->value()) {
      $service_menu_mlid = variable_get('hitsa_' . $service_type . '_mlid');
      if($service_submenu = menu_link_load($service_menu_mlid)) {
        // Create new menu link
        $menu_link = array();
        $menu_link['link_path'] = 'node/' . $node->nid;
        $menu_link['link_title'] = $node->title;
        $menu_link['plid'] = $service_menu_mlid;
        $menu_link['menu_name'] = 'hitsa-main-menu';
        menu_link_save($menu_link);
      }
    }
  }
}

/*
* Update menu link to service nodes.
*/
function hitsa_content_page_node_update($node) {
  if($node->type === 'content_page') {
    $emw_node = entity_metadata_wrapper('node', $node);
    $cp_type = $emw_node->cp_type->value();
    if($cp_type === 'cp_service' && $service_type = $emw_node->cp_service_type->value()) {
      $service_menu_mlid = variable_get('hitsa_' . $service_type . '_mlid');
      if($service_submenu = menu_link_load($service_menu_mlid)) {
        if(!empty($node->menu['mlid'])) {
          // Node settings, change existings
          $node->menu['link_path'] = 'node/' . $node->nid;
          $node->menu['link_title'] = $node->title;
          $node->menu['plid'] = $service_menu_mlid;
          $node->menu['menu_name'] = 'hitsa-main-menu';
        }
      }
    }
  }
}

function hitsa_content_page_update_page_type($form, &$form_state) {
  return $form;
}