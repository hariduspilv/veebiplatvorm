<?php
module_load_include('inc', 'hitsa_core', 'includes/hitsa_core.theme');
module_load_include('inc', 'hitsa_core', 'includes/hitsa_core.variable');

function hitsa_core_menu() {
  $items['admin/hitsa'] = array(
    'title' => 'HITSA Admin',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('variable_group_form', 'general_variables'),
    'access callback' => 'user_access',
    'access arguments' => array('administer content'),
    'weight' => -10,
  );
	$items['admin/hitsa/event_settings'] = array(
    'title' => t('Event settings'),
    'position' => 'left',
    'type' => MENU_LOCAL_TASK,
    'weight' => -19,
    'page callback' => 'hitsa_core_event_settings',
    'access arguments' => array('administer content'),
    'file' => 'includes/hitsa_core_events.admin.inc',
    
	);
  
  $items['admin/hitsa/variables'] = array(
    'title' => 'Variables',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'drupal_get_form',
    'page arguments' => array('variable_group_form', 'general_variables'),
    'access callback' => 'user_access',
    'access arguments' => array('administer content'),
  );
  
  $items['admin/hitsa/variables/general'] = array(
    'title' => 'General',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('variable_group_form', 'general_variables'),
    'type' => MENU_LOCAL_TASK,
    'access callback' => 'user_access',
    'access arguments' => array('administer content'),
    'weight' => 0,
  );
  
  $items['admin/hitsa/variables/header_footer'] = array(
    'title' => 'Header & Footer',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('variable_group_form', 'header_footer_variables'),
    'type' => MENU_LOCAL_TASK,
    'access callback' => 'user_access',
    'access arguments' => array('administer content'),
    'weight' => 1,
  );
  
  return $items;
}

function hitsa_core_preprocess_page(&$variables) {
  if(drupal_is_front_page()) {
    // Front page specific additions
    if(module_exists('hitsa_articles')) {
      
    }
  }
}

/**
 * Implements hook_preprocess_HOOK().
 */
function hitsa_core_preprocess_hitsa_header(&$variables) {
  // Load main menu
  $hitsa_main_menu_name = variable_get('hitsa_main_menu_name');
  if(!empty($hitsa_main_menu_name)) {
    $main_menu = menu_tree_all_data($hitsa_main_menu_name);
    $variables['main_menu'] = menu_tree_output($main_menu);
  }
  // Load header menu
  $hitsa_header_menu_name = variable_get('hitsa_header_menu_name');
  if(!empty($hitsa_header_menu_name)) {
    $header_menu = menu_tree_all_data($hitsa_header_menu_name);
    $variables['header_menu'] = menu_tree_output($header_menu);
    $variables['header_menu']['#theme_wrappers'] = array('header_menu_tree__hitsa_header_menu');
  }
  // Quicklinks menu
  $hitsa_quicklinks_menu_name = variable_get('hitsa_quicklinks_menu_name');
  if(!empty($hitsa_quicklinks_menu_name)) {
    $quicklinks_menu = menu_tree_all_data($hitsa_quicklinks_menu_name);
    $variables['quicklinks_menu'] = menu_tree_output($quicklinks_menu);
    $variables['quicklinks_menu']['#theme_wrappers'] = array('quicklinks_menu_tree__hitsa_quicklinks_menu');
  }
  // Language switcher
  $language_switcher = module_invoke('locale', 'block_view', 'language');
  if(!empty($language_switcher['content'])) {
    $variables['language_switcher'] = $language_switcher['content'];
  }
}

/**
 * Implements hook_preprocess_HOOK().
 */
function hitsa_core_preprocess_hitsa_footer(&$variables) {
  // General Contact
  $general_contact = variable_get_value('footer_general_contact');
  if(!empty($general_contact['value'])) {
    $variables['footer_general_contact'] = $general_contact['value'];
  }
  // Important contacts
  $important_contacts = variable_get_value('footer_important_contact');
  if(!empty($important_contacts['value'])) {
    $variables['footer_important_contact'] = $important_contacts['value'];
  }
  // Copyright notice
  $copyright_notice = variable_get_value('footer_copyright_notice');
  if(!empty($copyright_notice)) {
    $variables['copyright_notice'] = $copyright_notice;
  }
  // Footer menu
  $hitsa_footer_menu_name = variable_get('hitsa_footer_menu_name');
  if(!empty($hitsa_footer_menu_name)) {
    $footer_menu = menu_tree_all_data($hitsa_footer_menu_name);
    $variables['footer_menu'] = menu_tree_output($footer_menu);
  }
}

/*
* Implements hook_form_alter().
*/
function hitsa_core_form_alter(&$form, &$form_state, $form_id) {
  // Any node form with an academic year field.
  if(!empty($form['#node_edit_form']) && isset($form['academic_year'])) {
    hitsa_core_set_default_academic_year($form);
  }
}

function hitsa_core_set_default_academic_year(&$form) {
  $academic_year_field = &$form['academic_year'][LANGUAGE_NONE];
  // Set the current academic year as the default value.
  $query = new EntityFieldQuery();
  
  $now = time();
  $query->entityCondition('entity_type', 'taxonomy_term')
    ->entityCondition('bundle', 'academic_years')
    ->fieldCondition('academic_year_period', 'value', $now, '<=')
    ->fieldCondition('academic_year_period', 'value2', $now, '>=');
  
  $result = $query->execute();

  if(!empty($result['taxonomy_term'])) {
    // Set the matching academic year as the default value.
    $academic_year_term = reset($result['taxonomy_term']);
    $academic_year_field['#default_value'] = $academic_year_term->tid;
  } else {
    // Create new academic year term.
    $current_month = (int) date('n', $now);
    $current_year = (int) date('Y', $now);
    if($current_month >= 7) {
      $academic_year_string = sprintf('%d/%d', $current_year, $current_year + 1);
      $academic_year_from = strtotime('1. July ' . $current_year);
      $academic_year_to = strtotime('30. June ' . ($current_year + 1) . ' 23:59:59');
    } else {
      $academic_year_string = sprintf('%d/%d', $current_year - 1, $current_year);
      $academic_year_from = strtotime('1. July ' . ($current_year - 1));
      $academic_year_to = strtotime('30. June ' . $current_year . ' 23:59:59');
    }
    // New taxonomy term
    $term = new stdClass();
    $term->name = $academic_year_string;
    $term->vid = variable_get('hitsa_core_academic_years_vid');
    taxonomy_term_save($term);
    
    $emw_term = entity_metadata_wrapper('taxonomy_term', $term);
    
    $emw_term->academic_year_period = array('value' => $academic_year_from, 'value2' => $academic_year_to);
    $emw_term->save();
    
    // Set the new term as default.
    $academic_year_field['#options'][$emw_term->getIdentifier()] = $emw_term->label();
    $academic_year_field['#default_value'] = $emw_term->getIdentifier();
  }
}

function hitsa_core_get_content_by_type($e_type='node',$type=NULL,$language=NULL,$conditions=NULL){
  //dpm($type);
  $query = new EntityFieldQuery();
  $query -> entityCondition('entity_type',$e_type);
  $query -> entityCondition('bundle',$type);
  if ($e_type=='node') {
    $query -> propertyCondition('status',NODE_PUBLISHED);
  }
  if($type=='event'){
    $query -> fieldOrderBy('event_date','value','ASC');
  }
  if ($conditions) {
    foreach ($conditions as $condition_key => $condition) {
      if($condition_key=='event_type'){
        $query ->fieldCondition('field_event_type', 'value', $condition, '=');
      }
    }
  }
  if($language){
    $query -> propertyCondition('language',$language);
  }
  $result = $query->execute();
  return $result;
}